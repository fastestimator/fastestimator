pipeline {
  agent {label 'jenkins-pr'}
  environment{
      ANACONDA_DIR=/home/ubuntu/anaconda3
      ENV_NAME=pr_env
  }
  stages {
    stage('Build') {
      steps {
        sh '''
            . $ANACONDA_DIR/etc/profile.d/conda.sh
            if [ -d "$ANACONDA_DIR/envs/$ENV_NAME" ]; then
                conda remove --name $ENV_NAME -all -y
            fi
            conda create --name $ENV_NAME python=3.6 -y
            conda activate $ENV_NAME
            pip install pytest numpy nibabel pydicom twine ipython ipykernel
            conda install tensorflow-gpu=2.0.0
            pip install -e .
            pip freeze | tee requirement.txt
        '''
      }
    }
    stage('Test') {
        steps {
            sh '''
                . $ANACONDA_DIR/etc/profile.d/conda.sh
                conda activate $ENV_NAME
                python3 -m pytest
            '''
        }
    }
  }
}